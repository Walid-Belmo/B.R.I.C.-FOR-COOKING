================================================================================
                    EXHAUSTIVE ROBOTIC ARM TECHNICAL MANIFESTO
================================================================================
PROJECT: 4-DOF ESP32 Custom Robotic Arm
VERSION: 2.0 (Corrected for Mixed Servo Ranges)
DATE:    2026-01-05
TARGET:  Context for LLMs, Engineering Documentation, and Kinematics Engines.

================================================================================
1. PHYSICAL GEOMETRY & FRAME DEFINITIONS
================================================================================

1.1. GLOBAL REFERENCE FRAME (WORLD FRAME)
-----------------------------------------
The "World Frame" (Frame {0}) is the absolute zero for all Cartesian calculations.
- ORIGIN (0,0,0): Located at the geometric center of the turntable's top surface.
  * Note: The math accounts for the physical height from the floor (H_BASE)
    simply as a Z-translation in the final output.
- Z-AXIS (+): Vertical, pointing Up (opposite to gravity).
- X-AXIS (+): Horizontal, pointing "Forward" relative to the robot's base.
- Y-AXIS (+): Horizontal, pointing "Left" (Right-Hand Rule compliant).

1.2. JOINT DEFINITIONS & ACTUATOR MAPPING
-----------------------------------------
The robot uses mixed servo types with different angular ranges.

| Joint | Name      | Axis     | Model      | Range (Physical) | Pin |
| :---  | :---      | :---     | :---       | :---             | :--- |
| J1    | Turntable | Z (Yaw)  | TD-8120MG  | 270 deg (1.5 PI) | 13  |
| J2    | Shoulder  | X (Pitch)| TD-8120MG  | 270 deg (1.5 PI) | 14  |
| J3    | Elbow     | X (Pitch)| TD-8120MG  | 270 deg (1.5 PI) | 22  |
| J4    | Wrist     | Z (Roll) | MG90S      | 180 deg (1.0 PI) | 23  |

1.3. LINK OFFSET VECTORS (THE "JUMPS")
--------------------------------------
Measurements are relative to the PREVIOUS Joint's frame orientation.

* Base Height (H_BASE): 62.3 mm

* VECTOR J1 -> J2 (Turntable to Shoulder):
  - dx: 0.00 mm
  - dy: 16.625 mm
  - dz: 36.276 mm

* VECTOR J2 -> J3 (Shoulder to Elbow):
  - dx: 0.00 mm
  - dy: 0.00 mm
  - dz: 120.00 mm

* VECTOR J3 -> J4 (Elbow to Wrist):
  - dx: 11.08 mm
  - dy: 0.00 mm
  - dz: 93.85 mm

* VECTOR J4 -> TCP (Wrist to Tool Center Point):
  - dx: 0.00 mm
  - dy: 4.90 mm
  - dz: 45.60 mm

================================================================================
2. CONTROL LOGIC & SIGNAL CONVENTIONS
================================================================================

2.1. SERVO PROTOCOL
-------------------
- Signal: 50Hz PWM
- Pulse Width Range: 500us to 2500us (Span = 2000us)
- Neutral (Home) Position: 1500us

2.2. ANGULAR SCALING (CRITICAL)
-------------------------------
Different servos map the 2000us span to different angular ranges.

* SCALE_270 (J1, J2, J3):
  Range: 270 degrees (1.5 * PI radians)
  Factor: (1.5 * PI) / 2000.0  [approx 0.002356 rad/us]

* SCALE_180 (J4):
  Range: 180 degrees (1.0 * PI radians)
  Factor: (PI) / 2000.0        [approx 0.001571 rad/us]

2.3. DIRECTIONAL MAPPING
------------------------
Equation: Angle_Rad = (Pulse - 1500) * SCALE_FACTOR * DIRECTION

| Joint | Scale Used | Direction | Behavior (Pulse > 1500) |
| :---  | :---       | :---      | :---                    |
| J1    | SCALE_270  | +1.0      | Rotates CCW (Standard)  |
| J2    | SCALE_270  | +1.0      | Tilts Down (Positive)   |
| J3    | SCALE_270  | -1.0      | INVERTED (Tilts Up)     |
| J4    | SCALE_180  | +1.0      | Rotates CCW (Standard)  |

================================================================================
3. MATHEMATICAL IMPLEMENTATION (FORWARD KINEMATICS)
================================================================================

3.1. STEP-BY-STEP DERIVATION
----------------------------

STEP A: Calculate Angles (q)
   q1 = (P1 - 1500) * SCALE_270
   q2 = (P2 - 1500) * SCALE_270
   q3 = (P3 - 1500) * SCALE_270 * -1.0  (Inversion)
   q4 = (P4 - 1500) * SCALE_180

STEP B: Base Frame -> Joint 2 (Shoulder)
   x2 = (J2_OFF.x * cos(q1)) - (J2_OFF.y * sin(q1))
   y2 = (J2_OFF.x * sin(q1)) + (J2_OFF.y * cos(q1))
   z2 = H_BASE + J2_OFF.z

STEP C: Joint 2 -> Joint 3 (Elbow)
   x3 = x2
   y3 = y2 - (Link_Length * sin(q2) * cos(q1))
   z3 = z2 + (Link_Length * cos(q2))

STEP D: Joint 3 -> Joint 4 (Wrist)
   Theta_Forearm = q2 + q3
   
   j4_x = j3_x + (J4_OFF.x * cos(q1))
   j4_y = j3_y + (J4_OFF.x * sin(q1)) - (J4_OFF.z * sin(Theta_Forearm) * cos(q1))
   j4_z = j3_z + (J4_OFF.z * cos(Theta_Forearm))

STEP E: Joint 4 -> TCP
   Final TCP offset is applied relative to the wrist position.
   targetX = j4_x - (TCP_OFF.y * sin(q1)) - (TCP_OFF.z * sin(Theta_Forearm) * sin(q1))
   targetY = j4_y + (TCP_OFF.y * cos(q1)) - (TCP_OFF.z * sin(Theta_Forearm) * cos(q1))
   targetZ = j4_z + (TCP_OFF.z * cos(Theta_Forearm))

================================================================================
4. DATA STRUCTURES & CODE ARCHITECTURE
================================================================================

4.1. EXECUTION FLOW
-------------------
1. Serial Input ("s2-1600") 
2. Parse ID & Pulse.
3. Update global `currentPulses[]`.
4. Apply Scale & Direction in `getAngleRad()`.
5. Compute XYZ in `updateForwardKinematics()`.
6. Output to Serial.

================================================================================
END OF MANIFESTO
================================================================================